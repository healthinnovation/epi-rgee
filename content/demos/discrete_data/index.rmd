---
title: "2. Zonal statistics with discrete data"
author: "Gabriel Carrasco & Antony Barja"
date: 2020-12-01T21:13:14-05:00
tags: ["statisticzonal","discrete"]
---

The objective of this demo is to quantify the categories of landcover in [San Diego city](https://es.wikipedia.org/wiki/San_Diego_(California)) - USA. The dataset used 
is Copernicus Global Land Service (CGLS) which provides a series of bio-geophysical
products on the status and evolution of land surface at global scale to a spatial resolution of 100m.
More information [click here](https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_Landcover_100m_Proba-V-C3_Global#description)

---
<img src="https://user-images.githubusercontent.com/23284899/151858857-e98d6216-73be-4ffd-a95e-0b93fedbc0df.png" width="25px" align="center"><b> Information:</b>
- For this demo you need `rgee`, `sf`, `raster`, `tidyverse`, `ggspatial`, `patchwork` and `plotly` packages previously installed.
---

#### 2.1 Requirements
```{r, eval = FALSE}
library(rgee)
library(tidyverse)
library(sf)
library(ggspatial)
library(patchwork)
library(plotly)
library(raster)
ee_Initialize()
```
```
> ee_Initialize()
── rgee 1.1.2 ────────────────────────── earthengine-api 0.1.292 ── 
 ✓ user: not_defined
 ✓ Initializing Google Earth Engine:  DONE!
 ✓ Earth Engine account: users/ambarja 
─────────────────────────────────────────────────────────────────── 
```

#### 2.2 Vector layer reading of your study area 
```{r, eval = FALSE}
sandiego <- st_read(
  "https://github.com/healthinnovation/sdb-gpkg/raw/main/SanDiego.gpkg"
) %>%
  dplyr::select(NAME_2) 
head(sandiego)
```
```
> head(sandiego)
Simple feature collection with 1 feature and 1 field
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -117.5954 ymin: 32.53088 xmax: -116.0796 ymax: 33.5053
Geodetic CRS:  WGS 84
     NAME_2                           geom
1 San Diego MULTIPOLYGON (((-117.2394 3...
```

#### 2.3 Cooking data with rgee 

```{r, eval = FALSE}
lulc <- ee$Image("COPERNICUS/Landcover/100m/Proba-V-C3/Global/2019")$
  select("discrete_classification")
```
#### 2.4 A function that extracts the area of vegetation cover in hectares.

```{r, eval = FALSE}
ee_area_lulc <- function(img, region, scale = 1000) {
  lista_histo <- list()
  for (i in 1:nrow(region)) {
    region_ee <- region[i, ] %>% sf_as_ee()
    ee_histo <- img$reduceRegion(
      reducer = ee$Reducer$frequencyHistogram(),
      geometry = region_ee,
      scale = scale
    )
    lista_histo[[i]] <- ee_histo$getInfo() %>%
      map_df(., .f = as.data.frame) %>%
      mutate(NAME = region[[i, 1]] %>% as.vector())
  }
  histo_df <- map_df(lista_histo, .f = as.data.frame) %>%
    mutate_if(is.numeric, .funs = function(x) {
      x * 1000 * 1000 / 10000
    }) %>%
    replace(is.na(.), 0) %>%
    rename_with(~ paste0("Pi", sub("X", "", .), "_Ha"), -NAME)
  return(histo_df)
}
```
#### 2.5 Use of ee_area_lulc (rgee as backend) 

```{r,eval = FALSE}
area_Ha <- ee_area_lulc(img = lulc, region = sandiego)
```

#### 2.6 Identifying the type of vegetation cover according to the following table

<center>
 <a href="https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_Landcover_100m_Proba-V-C3_Global#bands">
   <img src="https://user-images.githubusercontent.com/23284899/152642180-ca0d6501-bad9-44bc-a862-42597c04a4bf.png" width="100%">
 </a>
</center>

```{r,eval = FALSE}
area_Ha <- area_Ha %>% 
  dplyr::select(NAME, ends_with("Ha")) %>% 
  gather(Category, values, Pi111_Ha:Pi90_Ha) %>% 
  mutate(
    Category = case_when(
      Category == "Pi20_Ha" ~ "Shrubs",
      Category == "Pi30_Ha" ~ "Herbaceous vegetation",
      Category == "Pi40_Ha" ~ "Herbaceous vegetation",
      Category == "Pi50_Ha" ~ "agriculture",
      Category == "Pi60_Ha" ~ "Bare",
      Category == "Pi80_Ha" ~ "Permanent water bodies",
      Category == "Pi90_Ha" ~ "Herbaceous wetland",
      Category == "Pi111_Ha" ~ "Closed forest",
      Category == "Pi116_Ha" ~ "Closed forest",
      Category == "Pi126_Ha" ~ "Open forest",
      Category == "Pi200_Ha" ~ "Water bodies",
    ),
    Unit = "Ha"
    ) %>% 
  as_tibble()
area_Ha
```

```
> area_Ha
# A tibble: 11 × 4
   NAME      Category                values Unit 
   <chr>     <chr>                    <dbl> <chr>
 1 San Diego Closed forest            1000  Ha   
 2 San Diego Closed forest           10553. Ha   
 3 San Diego Open forest            274954. Ha   
 4 San Diego Shrubs                 852717. Ha   
 5 San Diego Water bodies             3635. Ha   
 6 San Diego Herbaceous vegetation  124244. Ha   
 7 San Diego Herbaceous vegetation     600  Ha   
 8 San Diego agriculture            184500  Ha   
 9 San Diego Bare                   113547. Ha   
10 San Diego Permanent water bodies   6429. Ha   
11 San Diego Herbaceous wetland        200  Ha   
```

#### 2.7 Bar plot   

```{r,eval = TRUE,echo = FALSE,message = FALSE}
library(tidyverse)
library(plotly)
area_Ha <- read_rds("data/data_demo2")
```

```{r,eval = TRUE,out.width="100%"}
g1 <- area_Ha %>%
  ggplot(aes(x = reorder(Category,values), y = values, fill = Category)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  coord_flip() + 
  theme_minimal() + 
  labs(x = "", y = "")
ggplotly(g1) %>% 
  config(displayModeBar = F)
```

#### 2.8 Get raster data San Diego

```{r,eval = FALSE,out.width="100%"}
sandiego_raster <- ee_as_raster(
  image = lulc,
  region = sf_as_ee(sandiego)$geometry(),
  scale = 100,
  crs = "EPSG:4326")
```

```
- region parameters
 sfg      : MULTIPOLYGON (((-117.2394 3 .... 77584, -117.2328 32.77641))) 
 CRS      : GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563, ..... 
 geodesic : TRUE 
 evenOdd  : TRUE 

- download parameters (Google Drive)
 Image ID    : 2019 
 Google user : ndef 
 Folder name : rgee_backup 
 Date        : 2022_02_18_09_08_10 
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 0s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 5s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 10s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 15s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 20s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 25s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 30s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 35s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 40s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 45s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 50s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 55s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 60s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 65s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 70s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 75s>.
Polling for task <id: 5VHYXPG6TSAW7NGBQNOULXYO, time: 80s>.
State: COMPLETED
Moving image from Google Drive to Local ... Please wait  
```

```{r,eval = FALSE,out.width="100%"}
# Crop and mask raster data
sandiego_raster <- sandiego_raster %>% 
  crop(sandiego) %>% 
  mask(sandiego)
sandiego_raster
```

```
class      : RasterBrick 
dimensions : 1085, 1688, 1831480, 1  (nrow, ncol, ncell, nlayers)
resolution : 0.0008983153, 0.0008983153  (x, y)
extent     : -117.5958, -116.0794, 32.53069, 33.50536  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=WGS84 +no_defs 
source     : memory
names      : discrete_classification 
min values :                      20 
max values :                     200 
```

```{r,eval = FALSE,out.width="100%"}
# Raster layer to data.frame
sandiego_lucl <- sandiego_raster %>% 
  as.data.frame(xy = TRUE) %>% 
  drop_na()
head(sandiego_lucl)
```

```
> head(sandiego_lucl)
          x        y discrete_classification
1 -117.5100 33.50491                     126
2 -117.5091 33.50491                     126
3 -117.5082 33.50491                     126
4 -117.5073 33.50491                     126
5 -117.5064 33.50491                     126
6 -117.5055 33.50491                     126
```

#### 2.9 Categories classification 

```{r,eval = FALSE,out.width="100%"}
sandiego_lucl <- sandiego_lucl %>% 
  mutate(
    discrete_classification = case_when(
      discrete_classification == 20 ~ "Shrubs",
      discrete_classification == 30 ~ "Herbaceous vegetation",
      discrete_classification == 40 ~ "Herbaceous vegetation",
      discrete_classification == 50 ~ "agriculture",
      discrete_classification == 60 ~ "Bare",
      discrete_classification == 80 ~ "Permanent water bodies",
      discrete_classification == 90 ~ "Herbaceous wetland",
      discrete_classification == 111 ~ "Closed forest",
      discrete_classification == 116 ~ "Closed forest",
      discrete_classification == 126 ~ "Open forest",
      discrete_classification == 200 ~ "Water bodies")
    ) %>% 
  drop_na(discrete_classification) %>% 
  dplyr::rename(Category = discrete_classification)

```


#### 2.10 Final plot

```{r,eval = FALSE,out.width="100%"}
m1 <- ggplot() + 
  geom_sf(data = sandiego) +
  annotation_map_tile(zoom = 10) +
  geom_raster(
    data = sandiego_lucl,
    aes(x = x, y = y, fill = Category),alpha = 0.9) +
    scale_fill_viridis_d() +
    geom_sf(data = sandiego ,fill = NA,color = "white",lwd=0.5) + 
    theme(axis.text = element_text(size = 6),
          legend.position = "none") +
    labs(x = "", y = "")
m1 / g1

```

<center>
  <img src="https://user-images.githubusercontent.com/23284899/154709936-4edae82c-3e0f-4af6-9069-d91c375adcf6.png" width="100%">
</center>


