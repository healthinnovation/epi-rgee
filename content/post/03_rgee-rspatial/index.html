---
title: "3. Integration of rgee with r-spatial ecosystem"
author: "Gabriel Carrasco & Antony Barja"
date: 2020-12-01T21:13:14-05:00
tags: ["rspatial","tmap"]
featured: no
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>
<script src="{{< blogdown/postref >}}index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="{{< blogdown/postref >}}index_files/jquery/jquery.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/leaflet/leaflet.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/leaflet/leaflet.js"></script>
<link href="{{< blogdown/postref >}}index_files/leafletfix/leafletfix.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/proj4/proj4.min.js"></script>
<script src="{{< blogdown/postref >}}index_files/Proj4Leaflet/proj4leaflet.js"></script>
<link href="{{< blogdown/postref >}}index_files/rstudio_leaflet/rstudio_leaflet.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/leaflet-binding/leaflet.js"></script>
<script src="{{< blogdown/postref >}}index_files/leaflet-providers/leaflet-providers_1.9.0.js"></script>
<script src="{{< blogdown/postref >}}index_files/leaflet-providers-plugin/leaflet-providers-plugin.js"></script>
<script src="{{< blogdown/postref >}}index_files/clipboard/setClipboardText.js"></script>


<center>
<img src="https://user-images.githubusercontent.com/23284899/152370944-34183116-6abf-4b4f-b1d0-b65620bc614d.png" width="90%" heigth="80px">
</center>
<p>In recent years the R spatial community has had a big impact on big data, especially with the processing of spatial data,
both in vector format (points, lines, polygons, etc.) and raster format (satellite images, drones, etc.).</p>
<p>Nowadays, there are many packages within R spatially to work on a key aspect within spatial analysis,
from the evaluation of a Moran test to cluster identification, geographic weighted regression,
pre and post processing of satellite images or drone images, among others; there is also a great
potential within spatial data visualizations, from simple static visualizations, to dynamic and interactive ones,
including 3D visualizations.</p>
<p>However, there is a huge gap for processing large volumes of data without high computational costs,
and it is precisely in this aspect that the rgee package aims to work and be part of this ecosystem
to process large spatial datasets in an accessible and user-friendly way hand in hand
with the integration of the spatial universe of R packages.</p>
<div id="mapping-the-past-temperature" class="section level3">
<h3>Mapping the past temperature</h3>
<p>For this example, we use the ERA5-Land dataset, a reanalysis dataset providing a consistent view of the evolution of
land variables over several decades at an enhanced resolution compared to ERA5, more information <a href="https://developers.google.com/earth-engine/datasets/catalog/ECMWF_ERA5_LAND_MONTHLY">click here.</a></p>
<div id="requeriments" class="section level4">
<h4>3.1 Requeriments</h4>
<pre class="r"><code>library(rgee)
library(tmap)
library(raster)
library(cptcity)
ee_Initialize() # Initialize gee inside R with registered account</code></pre>
<pre><code>## ── rgee 1.1.2.9000 ────────────────────────────────── earthengine-api 0.1.297 ── 
##  ✓ user: not_defined
##  ✓ Initializing Google Earth Engine:
 ✓ Initializing Google Earth Engine:  DONE!
## 
 ✓ Earth Engine account: users/antonybarja8 
## ────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div id="cooking-data-with-rgee" class="section level4">
<h4>3.2 Cooking data with rgee</h4>
<pre class="r"><code>dataset &lt;- ee$ImageCollection$Dataset$ECMWF_ERA5_LAND_MONTHLY
past &lt;- dataset$
  select(&quot;temperature_2m&quot;)$
  filter(
    ee$Filter$date(&quot;1992-01-01&quot;,&quot;1992-12-31&quot;)
    )$
  mean()$
  subtract(273.15)</code></pre>
</div>
<div id="simple-visualization" class="section level4">
<h4>3.3 Simple visualization</h4>
<pre class="r"><code>viz &lt;- list(
  min = 5,
  max = 25,
  palette = cpt(pal = &quot;gmt_GMT_seis&quot;,rev = 1)
  )
Map$addLayer(past,visParams = viz) + 
  Map$addLegend(visParams = viz,name = &quot;Tem[C°]&quot;)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addLayersControl","args":[["CartoDB.Positron","OpenStreetMap","CartoDB.DarkMatter","Esri.WorldImagery","OpenTopoMap"],[],{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addTiles","args":["https://earthengine.googleapis.com/v1alpha/projects/earthengine-legacy/maps/c8f5dfc2b410f3e4ea6351f436980b45-9e15cdeb2aac185a45af3b564dfc4095/tiles/{z}/{x}/{y}","untitled_34a06d3764a7","untitled_34a06d3764a7",{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false}]},{"method":"addLayersControl","args":[["CartoDB.Positron","OpenStreetMap","CartoDB.DarkMatter","Esri.WorldImagery","OpenTopoMap"],"untitled_34a06d3764a7",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"hideGroup","args":[null]},{"method":"addLegend","args":[{"colors":["#0000CD , #0000CD 0%, #16F35A 25%, #FFFF00 50%, #FF6A00 75%, #AA0000 100%, #AA0000 "],"labels":["5","10","15","20","25"],"na_color":null,"na_label":"NA","opacity":1,"position":"bottomright","type":"numeric","title":"Tem[C°]","extra":{"p_1":0,"p_n":1},"layerId":null,"className":"info legend","group":null}]}],"setView":[[0,0],1,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
<!-- <center> -->
<!--  <img src="https://user-images.githubusercontent.com/23284899/152621719-c5e1656a-3bdb-40a2-8ac5-12d76cef7f1c.png" width="100%"> -->
<!-- </center> -->
</div>
<div id="define-box-to-study-area" class="section level4">
<h4>3.4 Define box to study area</h4>
<pre class="r"><code>geometry &lt;- ee$Geometry$Rectangle(
  coords = c(-180,-90,180,90),
  proj = &quot;EPSG:4326&quot;,
  geodesic = FALSE
)</code></pre>
</div>
<div id="identifying-min-and-max-values-of-temperature" class="section level4">
<h4>3.5 Identifying min and max values of temperature</h4>
<pre class="r"><code>(minmax &lt;- past$reduceRegion(
  reducer = ee$Reducer$minMax(),
  geometry = geometry,
  scale = 500*1000)$
  getInfo())</code></pre>
<pre><code>$temperature_2m_max
[1] 29.68718

$temperature_2m_min
[1] -53.14849</code></pre>
</div>
<div id="generate-a-thumbnail-image-in-a-rasterlayer-or-stars-format" class="section level4">
<h4>3.6 Generate a thumbnail image in a rasterlayer or stars format</h4>
<pre class="r"><code>world_temp &lt;- ee_as_thumbnail(
  image = past,        # Image to export
  region = geometry,   # Region of interest
  dimensions = 1024,   # output dimension
  raster = TRUE,       # If FALSE returns a stars object. FALSE by default
  vizparams = list(min = -53.14849, max = 29.68718)
)</code></pre>
</div>
<div id="cooking-data-for-mapping-with-tmap" class="section level4">
<h4>3.7 Cooking data for mapping with tmap</h4>
<pre class="r"><code># Define a projection (EPSG:4326 - WGS 84)
crs(world_temp) &lt;- 4326
world_temp[] &lt;- scales::rescale(
  getValues(world_temp),
  c(minmax$temperature_2m_min, minmax$temperature_2m_max)
) 
# Load world vector (available after load tmap)
data(&quot;World&quot;) 

# Define a Robin type projection 
robin &lt;- &quot;+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs&quot;

# Remove the temperature value of sea
map &lt;-  world_temp %&gt;% 
  mask(World) </code></pre>
</div>
<div id="elaboration-of-the-temperature-map" class="section level4">
<h4>3.8 Elaboration of the Temperature Map</h4>
<pre class="r"><code>temp_map &lt;- map %&gt;% 
  tm_shape(projection = robin,raster.warp = FALSE) +
  tm_raster(
    title = &quot;Temperature (°C)&quot;,
    palette = cpt(&quot;gmt_GMT_seis&quot;, n = 100, rev = 1),
    style = &quot;cont&quot;
  ) + 
  tm_shape(shp = World) + 
  tm_borders(col = &quot;black&quot;,lwd = 0.7) + 
  tm_graticules(alpha = 0.8, lwd = 0.5, labels.size = 0.5) +
  tm_layout() +
  tmap_style(style = &quot;natural&quot;) +
  tm_layout(
    scale = 0.8,
    bg.color = &quot;gray90&quot;,
    frame = FALSE,
    frame.lwd = NA,
    panel.label.bg.color = NA,
    attr.outside = TRUE,
    main.title.size = 0.8,
    main.title = &quot;Global monthly mean Temperature\nfrom ERA5-Land - 1992&quot;,
    main.title.fontface = 2,
    main.title.position = 0.1,
    legend.title.size = 1,
    legend.title.fontface = 2,
    legend.text.size = 0.7,
    legend.frame = FALSE,
    legend.outside = TRUE,
    legend.position = c(0.10, 0.38),
    legend.bg.color = &quot;white&quot;,
    legend.bg.alpha = 1
  ) +
  tm_credits(
    text = &quot;Source: ERA5-Land Monthly Averaged - ECMWF Climate Reanalysis&quot;,
    size = 0.8
    ) </code></pre>
</div>
<div id="export-map-in-png-format" class="section level4">
<h4>3.9 Export map in png format</h4>
<pre class="r"><code>tmap_save(temp_map,&quot;temp_map.png&quot;,width = 6,height = 3)</code></pre>
<center>
<img src="https://user-images.githubusercontent.com/23284899/152614266-7fac2efc-f1e8-4c77-9ef8-dbdc71e5ba7c.png" width="100%">
</center>
</div>
</div>
